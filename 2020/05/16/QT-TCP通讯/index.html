<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="QT-TCP通讯, 左轮">
    <meta name="description" content="欢迎">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>QT-TCP通讯 | 左轮</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="左轮" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">左轮</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Medias</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/musics">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Musics</span>
        </a>
      </li>
      
      <li>
        <a href="/movies">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Movies</span>
        </a>
      </li>
      
      <li>
        <a href="/books">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Books</span>
        </a>
      </li>
      
      <li>
        <a href="/galleries">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Galleries</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">左轮</div>
        <div class="logo-desc">
            
            欢迎
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Medias
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/musics " style="margin-left:50px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:28px" ></i>
			      
		          <span>Musics</span>
                  </a>
                </li>
              
                <li>

                  <a href="/movies " style="margin-left:50px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:28px" ></i>
			      
		          <span>Movies</span>
                  </a>
                </li>
              
                <li>

                  <a href="/books " style="margin-left:50px">
				  
				   <i class="fa fas fa-book" style="position: absolute;left:28px" ></i>
			      
		          <span>Books</span>
                  </a>
                </li>
              
                <li>

                  <a href="/galleries " style="margin-left:50px">
				  
				   <i class="fa fas fa-image" style="position: absolute;left:28px" ></i>
			      
		          <span>Galleries</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">QT-TCP通讯</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/QT/">
                                <span class="chip bg-color">QT</span>
                            </a>
                        
                            <a href="/tags/%E8%AE%A1%E7%BD%91%E8%AF%BE%E8%AE%BE/">
                                <span class="chip bg-color">计网课设</span>
                            </a>
                        
                            <a href="/tags/TCP%E9%80%9A%E8%AE%AF/">
                                <span class="chip bg-color">TCP通讯</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-05-16
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2020-05-16
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    2.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    15 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>[toc]</p>
<h4 id="实现内容"><a href="#实现内容" class="headerlink" title="实现内容"></a>实现内容</h4><ul>
<li>多人聊天室</li>
<li>文件传输</li>
<li>多人语音聊天室</li>
</ul>
<h4 id="效果截图"><a href="#效果截图" class="headerlink" title="效果截图"></a>效果截图</h4><h5 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h5><p><img src="/.io//C:%5CUsers%5Clenovo%5CDesktop%5C12.png" alt="服务器"></p>
<h5 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h5><p><img src="/.io//C:%5CUsers%5Clenovo%5CDesktop%5C12.png" alt="12"></p>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><h5 id="服务器端-1"><a href="#服务器端-1" class="headerlink" title="服务器端"></a>服务器端</h5><p>注 pro文件需要添加</p>
<p><code>QT       += core gui network multimedia</code></p>
<h6 id="serverwidget-h"><a href="#serverwidget-h" class="headerlink" title="serverwidget.h"></a>serverwidget.h</h6><pre class=" language-QT"><code class="language-QT">#ifndef SERVERWIDGET_H
#define SERVERWIDGET_H

#include <QWidget>
#include <QTcpServer>
#include <QTcpSocket>
#include <QVector>

#include <QFile>
#include <QTimer>//计时器

#include <QAudio>//一下这五个是QT处理音频的库
#include <QAudioFormat>
#include <QAudioInput>
#include <QAudioOutput>
#include <QIODevice>

QT_BEGIN_NAMESPACE
namespace Ui { class ServerWidget; }
QT_END_NAMESPACE

struct people{
    QString pip;
    QString name;
    int pport;
};


/*********************************************/
const char file_flag = 'F';
const char head_flag = 'H';
const QString MSG_flag = "MSG##";
const char sys_flag = '!';
const char people_new = 'N';//新的用户到来  姓名传输过来

const char to_c_people_new = 'P';//新的用户到来  传给客户端
const char to_c_people_del = 'D';//新的用户离开  传给客户端

/*********************************************/


class ServerWidget : public QWidget
{
    Q_OBJECT

public:
    ServerWidget(QWidget *parent = nullptr);
    ~ServerWidget();

private slots:
    void on_pushButton_clicked();

    //
    void on_ButtonSelect_clicked();
    void on_ButtonSend_clicked();

    void sendData(QTcpSocket* tcpSocket, int i);//发送文件数据

    void onReadyRead();
    void readyReadSlot();//receive

private:
    Ui::ServerWidget *ui;

    QTcpServer *tcpserver;//监听套接字
    QVector<QTcpSocket *> socketarr;

    int count = 0;
    QFile  file[1024];//文件对象
    QString fileName; //文件名字
    QString filePath; //文件路径
    qint64 fileSize;//文件大小
    qint64 sendSize[1024];//已发送文件大小

        QTimer timer[1024];//定时器  黏包  头部----文件体

    QFile  file2;//文件对象
    QString fileName2;//文件名字
    qint64 fileSize2;//文件大小
    qint64 recvSize2;//已发送文件大小

    bool readyFile;

    /*********************************************/
    QVector<people> plist;
    /*********************************************/

    /*音频*/
    QVector<QTcpSocket *> phonetcpsocket;
    QTcpServer *phonetcpserver;
    int phone_count=0;
    QAudioInput *input;//音频采集
    QIODevice   *inputDevice;//播放
    QAudioOutput *output;
    QIODevice   *outputDevice;



protected:
    void paintEvent(QPaintEvent *event);
};
struct video{
    char audiodata[1024];
    int lens;
};
#endif // SERVERWIDGET_H</code></pre>
<h6 id="serverwidget-cpp"><a href="#serverwidget-cpp" class="headerlink" title="serverwidget.cpp"></a>serverwidget.cpp</h6><pre class=" language-QT"><code class="language-QT">#include "serverwidget.h"
#include "ui_serverwidget.h"
#include <QFileDialog>//选择文件的对话框
#include <QDebug>//用于debug
#include <QFileInfo>//用于获取文件信息
#include <QMap>
#include <QStyleFactory>
#include <QPainter>
#include <QMessageBox>

ServerWidget::ServerWidget(QWidget *parent)
    : QWidget(parent)
    , ui(new Ui::ServerWidget)
{
    ui->setupUi(this);
    resize(1000, 600);
    tcpserver = NULL;
    recvSize2 = 0;
    readyFile = false;
    tcpserver = new QTcpServer(this);   //监听套接字

    ui->pushButton->setStyleSheet("background-color: rgb(175,238,238)");
    ui->textEdit_online->setStyleSheet("background-color: rgba(255, 0, 255, 60)");
    ui->textEdit->setStyleSheet("background-color: rgba(0, 255, 255, 60)");
    ui->textEditFile->setStyleSheet("background-color: rgba(255, 0, 255, 60)");
    ui->progressBar->hide();

    for(int i=0;i<1024;i++)sendSize[i]=0;

}

void ServerWidget::paintEvent(QPaintEvent *)
{
    QPainter p(this);
    p.drawPixmap(0, 0, width(), height(), QPixmap("../src/b3.jpg"));
}

ServerWidget::~ServerWidget()
{
    delete ui;
}

//聊天室按钮
void ServerWidget::on_pushButton_clicked()
{
    //获取端口号
    if(ui->lineEdit->text()=="")return;
    qint16 port = ui->lineEdit->text().toInt();

    //监听
    tcpserver->listen(QHostAddress::Any,port);

    setWindowTitle("服务器："+ui->lineEdit->text());
    ui->textEdit->setText("聊天室创建成功！");

    //如果新进客户端与服务器连接，tcpServer会自动触发newConnection()
    connect(tcpserver,&QTcpServer::newConnection,
            [=]()
                {
                     count++;
                     ui->labelonline->setText("当前在线人数："+QString::number(count));
                     //取出socket
                     QTcpSocket *socket;
                     socket = tcpserver->nextPendingConnection();
                     //加入数组
                     socketarr.push_back(socket);

                     QString ip = socket->peerAddress().toString();//取出ip


                     ip = ip.right(ip.length()-7);    //删除前缀
                     qint16 port = socket->peerPort();//取出端口

                     /***********************************加入新的用户**************************************/
                     people per;
                     per.pip = ip;
                     per.pport = port;
                     per.name = "NULL";
                     plist.push_back(per);
                     /***********************************************************************************/

                     //组包提示信息
                     QString temp = QString("[%1%2]:进入聊天室").arg(ip).arg(port);
                     ui->textEdit_online->append(ip);//增加显示当前所有的用户ip
                     ui->textEdit->append(temp);
                     temp = MSG_flag+temp;
                     //广播新进用户
                     for(int i=0;i<count;i++){
                         socketarr[i]->write(temp.toUtf8().data());
                     }



                     connect(socket,&QTcpSocket::readyRead,
                             [=]()
                                {
                                    //取内容
                                    QByteArray byteBuf = socket->readAll();
                                    QString buf =byteBuf;
                                    if(readyFile)//接收文件信息
                                    {
                                        qint64 len = file2.write(byteBuf);
                                        recvSize2 += len;
                                        if(recvSize2 == fileSize2)
                                        {
                                           QString str = QString("收到文件：[%1: %2KB]").arg(fileName2).arg(fileSize2/1024);
                                           file2.close();
                                           QMessageBox::information(this,"文件信息",str);
                                           recvSize2 = 0;
                                           readyFile = false;
                                        }
                                        return;
                                    }
                                    if(buf[0]==people_new)
                                    {
                                        //取出ip
                                        QString ip = socket->peerAddress().toString();//取出ip
                                        //删除前缀
                                        ip = ip.right(ip.length()-7);
                                        qint16 port1 = socket->peerPort();//取出端口

                                        QString thename;
                                        for(int j=1;j<buf.size();j++){
                                             thename[j-1] = buf[j];
                                        }

                                        for(int i=0;i<plist.size();i++){
                                            if(plist[i].pip==ip && plist[i].pport == port1){
                                                plist[i].name = thename;
                                                                                     /**发给客户端*/
                                                QString thestring;

                                                thestring = to_c_people_new + plist[i].pip +sys_flag+ QString::number(plist[i].pport) + sys_flag + plist[i].name;
                                                //P  ip  ! port ! name

                                                for(int i=0;i<count;i++){
                                                    socketarr[i]->write(thestring.toUtf8().data());
                                                }
                                                return;
                                            }
                                        }
                                    }
                                    else if(buf[0] == sys_flag)
                                    {
                                        //信息：
                                        buf = buf.right(buf.length()-1); //去掉sys_flag
                                        QString ip = socket->peerAddress().toString();//取出ip
                                        qint16 port = socket->peerPort();//取出端口号
                                        ip = ip.right(ip.length()-7); //删除ip前缀


                                        //文件反馈信息
                                        if(buf == "filedone"){
                                           QString thetemp = QString(ip+":"+"文件已接收");
                                           ui->textEditFile->append(thetemp);
                                        }
                                        else if(buf == "Close")//接收到用户端退出产生的反馈
                                        {

                                            /*******************************************************************************/
                                            /********************************用户离开****************************************/
                                            for(int i=0;i<plist.size();i++){
                                                if(plist[i].pip==ip && plist[i].pport == port){
                                                     /*发给客户端*/
                                                     QString str;
                                                     str = to_c_people_del + plist[i].pip +"!" + QString::number(plist[i].pport);
                                                     //P  ip ! port

                                                     for(int i=0;i<count;i++){
                                                         socketarr[i]->write(str.toUtf8().data());
                                                     }

                                                     plist.remove(i);
                                                     break;
                                                }
                                            }
                                            /********************************************************************************/

                                            for(int i=0;i<count;i++){
                                                int iplen = socketarr[i]->peerAddress().toString().length()-7;
                                                if(socketarr[i]->peerAddress().toString().right(iplen)==ip){
                                                    QString temp = QString("[%1%2]:离开聊天室").arg(ip).arg(port);
                                                    ui->textEdit->append(temp);
                                                    temp = "MSG##"+temp;
                                                    //广播出去
                                                    for(int j=0;j<count;j++){
                                                       socketarr[j]->write(temp.toUtf8().data());
                                                    }
                                                    //删除
                                                    socketarr.remove(i);
                                                    count--;
                                                    ui->labelonline->setText("当前在线人数："+QString::number(count));
                                                    break;
                                               }
                                            }


                                            //在存在用户退出后，更新显示当前在线用户端ip
                                            if(count==0)
                                            {
                                               ui->textEdit_online->setText("");
                                            }
                                            else
                                            {
                                                //显示首ip
                                                QString ip = socketarr[0]->peerAddress().toString();//取出ip
                                                //删除前缀！
                                                ip = ip.right(ip.length()-7);
                                                ui->textEdit_online->setText(ip);


                                                //显示剩余ip
                                                for(int i=1;i<count;i++)
                                                {
                                                QString ip = socketarr[i]->peerAddress().toString();//取出ip
                                                //删除前缀！
                                                ip = ip.right(ip.length()-7);
                                                ui->textEdit_online->append(ip);
                                                }
                                            }
                                       }
                                    }
                                    else if(buf.left(5) == MSG_flag)    //文本信息广播出去
                                    {
                                        QString temp1 = QString(buf);
                                        ui->textEdit->append(temp1);
                                        for(int i=0;i<count;i++){
                                            socketarr[i]->write(temp1.toUtf8().data());
                                        }
                                    }
                                    else if(buf[0] == head_flag)
                                    {
                                        fileName2 = buf.section("##",1,1);
                                        fileSize2 = buf.section("##",2,2).toInt();
                                        file2.setFileName("../files/"+fileName2);
                                        bool isOk = file2.open( QFile::WriteOnly);
                                        ui->textEditFile->append("收到文件：" + file2.fileName());
                                        if(false == isOk)
                                        {
                                            QMessageBox::information(this,"文件信息","服务器炸了QWQ");
                                            close();
                                        }
                                        readyFile = true;

                                    } 
                                }
                             );

                }
    );

    /**************************************************************************************/
    //监听socket
    phonetcpserver = new QTcpServer;

    //receive
    //qint16 phoneport = ui->lineEditphone->text().toInt();
    phonetcpserver->listen(QHostAddress::Any,this->ui->lineEditphone->text().toInt());
    connect(phonetcpserver,&QTcpServer::newConnection,
           [=]()
           {
                QTcpSocket * thesocket;
                thesocket = phonetcpserver->nextPendingConnection();//取出socket
                QString ip = thesocket->peerAddress().toString();
                int port = thesocket->peerPort();
                ip = ip.right(ip.length()-7);
                ui->textEdit->setText(QString("%1::%2-进入语音聊天室").arg(ip).arg(port));

                //connect 一定要写在newConnection内
                connect(thesocket,SIGNAL(readyRead()),this,SLOT(readyReadSlot()));//receiv  important
                phonetcpsocket.push_back(thesocket);
                phone_count++;
    });



    QAudioFormat format; //采样设置
    format.setCodec("audio/pcm");//编码
    format.setByteOrder(QAudioFormat::LittleEndian);
    format.setSampleRate(8000);//采样评率
    format.setSampleSize(16);//采样点数据位数
    format.setSampleType(QAudioFormat::UnSignedInt);//返回采样点格式
    format.setChannelCount(1);//音频数据通道数

    input = new QAudioInput(format,this);//采用格式
    inputDevice = input->start();//采集声音


    output = new QAudioOutput(format,this);
    outputDevice = output->start();//开始播放
    connect(inputDevice,SIGNAL(readyRead()),this,SLOT(onReadyRead()));
    /**************************************************************************************/


}



//选择文件按钮
void ServerWidget::on_ButtonSelect_clicked()
{
    QString fPath = QFileDialog::getOpenFileName(this,"open","../");

    if(false == fPath.isEmpty())//如果选择文件路径有效
    {
        //初始化
        fileName.clear();
        fileSize = 0;
//        sendSize = 0;
        filePath = fPath;
        //获取文件信息
        QFileInfo info(filePath);
        fileName = info.fileName();
        fileSize = info.size();


    }
    else
    {
        qDebug() << "选择文件路径出错 62";
    }
}

void ServerWidget::on_ButtonSend_clicked()
{
    qDebug()<<"on_ButtonSend_clicked"<<endl;
    //先发送文件头信息 文件名##文件大小
    QString subhead = QString("%1##%2").arg(fileName).arg(fileSize);
    QString head = head_flag + subhead;


    //(广播)发送头部信息
    for(int i=0;i<count;i++)
    {
        qint64 len = socketarr[i]->write(head.toUtf8());

        if(len > 0)//头部信息发送成功
        {
            //发送真正的文件信息
            //防止TCP黏包，需要通过定时器延时20ms
            //文件传输计时器
            connect(&timer[i],&QTimer::timeout,
                    [=]()
                    {
                        //关闭定时器
                        timer[i].stop();
                        //发送文件
                        sendData(socketarr[i], i);
                    }
                   );
            timer[i].start(20);
        }
        else{
            qDebug() << "头部信息发送失败 110";
        }
    }

}



void ServerWidget::sendData(QTcpSocket* tcpSocket, int i)
{

    //指定文件名
    file[i].setFileName(filePath);
    //打开文件
    bool isOk = file[i].open(QIODevice::ReadOnly);
    if(false == isOk)
    {
        qDebug() << "只读方式打开文件失败 77";
    }
    //提示打开文件的路径
    ui->textEditFile->append(filePath);
    ui->progressBar->show();
    ui->progressBar->setRange(0, fileSize);
    ui->progressBar->setValue(0);

    qint64 len = 0;
    do
    {
        //每次发送数据的单位（缓冲区大小）
        char buf[4 * 1024] = {0};
        len = 0;
        //往文件中读数据
        len = file[i].read(buf,sizeof(buf));
        //发送数据
        len = tcpSocket->write(buf,len);
        //发送的数据需要累积
        sendSize[i] += len;
        ui->progressBar->setValue(sendSize[i]);

    }while(len > 0);

    //判断是否发送文件完毕
    if(sendSize[i] == fileSize)
    {
        sendSize[i] = 0;//以免重复弹出完成提示
        ui->progressBar->hide();
        file[i].close();
        if(i==count-1)
        QMessageBox::information(this,"文件信息","文件传输完毕");
    }
}

/***********************************************************/
void ServerWidget::onReadyRead()
{
    qDebug()<<"onReadyRead"<<endl;
    /*----------------------------------send************************/
        video vp;
        memset(&vp,0,sizeof(vp));
        //读取音频
//        vp.lens = inputDevice->read(vp.audiodata,1024);//读取音频

//        for(int j=0;j<phone_count;j++){
//            phonetcpsocket[j]->write((const char*)&vp,sizeof(vp));
//        }

}

void ServerWidget::readyReadSlot()
{
        qDebug() << "read" ;
        int size = output->periodSize();

        QByteArray bug;

        qDebug()<<"audio is being received..."<<endl;


        for(int k=0;k<phone_count;k++){
            bug = phonetcpsocket[k]->readAll();
            if(bug=="")continue;
            for(int j=0;j<phone_count;j++){
                if(k == j)  continue;
                phonetcpsocket[j]->write(bug,size);
            }
        }
}

</code></pre>
<h6 id="main-cpp"><a href="#main-cpp" class="headerlink" title="main.cpp"></a>main.cpp</h6><pre class=" language-QT"><code class="language-QT">#include "serverwidget.h"

#include <QApplication>
#include <QStyleFactory>
#include <QFile>
int main(int argc, char *argv[])
{
    QApplication a(argc, argv);
    a.setStyle(QStyleFactory::create("Fusion"));
    ServerWidget w;
    w.show();

    return a.exec();
}
</code></pre>
<h5 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h5><p>注：pro文件添加</p>
<p><code>QT       += core gui network multimedia</code></p>
<h6 id="item-h"><a href="#item-h" class="headerlink" title="item.h"></a>item.h</h6><pre class=" language-QT"><code class="language-QT">#ifndef ITEM_H
#define ITEM_H
#include <QString>
#include <QPushButton>
#include <QWidget>
#include <QHBoxLayout>
#include <QTextEdit>
class ITEM
{
private:
    QTextEdit *msgbtn;
    QPushButton *imgbtn;
    QWidget *itw;
    QHBoxLayout *hlayout;
    QString name;
    QString color;
    QString align;
    int fheight(const QString &str, int w);
    int fwidth(const QString &str, int w);


public:
    ITEM(const QString &msg, const QString &name,const QString &ali , QWidget *w, QFont *f=NULL, bool vis=true);
    void resize(int w, int h);
    void setMsg(const QString &msg);
    void setStyle(QFont *f, double r, double w, double h);
    QWidget* Item();
};

#endif // ITEM_H</code></pre>
<h6 id="item-cpp"><a href="#item-cpp" class="headerlink" title="item.cpp"></a>item.cpp</h6><pre class=" language-QT"><code class="language-QT">#include "item.h"
#include <QVBoxLayout>
#include <cmath>
using namespace std;

int ITEM::fwidth(const QString &str, int w)
{
    QFont f = msgbtn->font();
    QFontMetrics fm(f);
    QStringList sl = str.split('\n');
    int ma=0;
    for(auto s:sl)
    {
        if(ma < fm.boundingRect(s).width()+20)
        {
            ma = fm.boundingRect(s).width()+20;
        }
    }
    return min(ma, int(0.6*w));
}

int ITEM::fheight(const QString &str, int w)
{
    QFont f = msgbtn->font();
    QFontMetrics fm(f);
    QStringList sl = str.split('\n');
    int res=12;
    int h = fm.boundingRect(str).height();
    for(auto s:sl)
    {
        res += h;
        if(fm.boundingRect(s).width()+20 > int(0.6*w))
        {
            res += fm.boundingRect(s).width() / (int(0.6*w)-20) * h;
        }
    }
    return max(res, 60);
}

ITEM::ITEM(const QString &msg, const QString &name, const QString &ali, QWidget *W,
           QFont *f, bool vis)
{
    align = ali;
    itw = new QWidget(W);
    hlayout = new QHBoxLayout();
    itw->setLayout(hlayout);
    QString btnMsg="  ";
    for(int i=0, l=msg.length();i<l;i++)
    {
        if(msg[i] == '\n')
        {
            btnMsg.push_back("\n  ");
        }
        else
        {
            btnMsg.push_back(msg[i]);
        }
    }
    btnMsg.push_back("  ");
    msgbtn = new QTextEdit(itw);
    msgbtn->setText(btnMsg);
    msgbtn->setReadOnly(true);
    imgbtn = new QPushButton(itw);
    if(align == "left")
    {
        hlayout->addWidget(imgbtn);
        hlayout->addWidget(msgbtn);
        hlayout->addStretch();

    }
    else
    {
        hlayout->addStretch();
        hlayout->addWidget(msgbtn);
        hlayout->addWidget(imgbtn);

    }
    imgbtn->resize(25, 25);
    if(f == NULL)
    {
        f = new QFont();
        f->setFamily("微软雅黑");
        f->setPixelSize(20);
    }
    msgbtn->setFont(*f);
    QString alpha = "255";
    if(!vis)    alpha="0";
    if(name == "刘朝日")
    {
        this->name = "lzr.png";
        this->color = "rgba(169,209,142,"+alpha+");";
    }
    else if(name == "刘硕")
    {
        this->name = "ls.png";
        this->color = "rgba(255,217,102,"+alpha+");";
    }
    else if(name == "曹文豪")
    {
        this->name = "cwh.png";
        this->color = "rgba(157,195,230,"+alpha+");";
    }
    else if(name == "刘涵准")
    {
        this->name = "lhz.png";
        this->color = "rgba(102,204,255,"+alpha+");";
    }
    else if(name == "雷艳")
    {
        this->name = "ly.png";
        this->color = "rgba(252,209,216,"+alpha+");";
    }
    imgbtn->setFixedSize(60, 60);
    imgbtn->setStyleSheet("border-image:url(../src/"+ this->name +");"
                          "border-radius:30px;");
    msgbtn->setStyleSheet("background-color:"+this->color +
                          "border-radius: 5px;"
                          );
    msgbtn->setMinimumHeight(60);

    hlayout->setMargin(20);
}

void ITEM::resize(int w, int h)
{
    msgbtn->setFixedSize(fwidth(msgbtn->document()->toPlainText(), w),
                         fheight(msgbtn->document()->toPlainText(), w));
    itw->resize(w, max(max(h, int(1.3*imgbtn->height())), int(1.3*msgbtn->height())));

}

void ITEM::setMsg(const QString &msg)
{
    msgbtn->setText(msg);
}

QWidget* ITEM::Item()
{
    return itw;
}
</code></pre>
<h6 id="clientwidget-h"><a href="#clientwidget-h" class="headerlink" title="clientwidget.h"></a>clientwidget.h</h6><pre class=" language-QT"><code class="language-QT">#ifndef CLIENTWIDGET_H
#define CLIENTWIDGET_H

#include <QWidget>
#include <QTcpSocket>

//音频信息
#include <QDialog>
#include <QtNetwork/QUdpSocket>
#include <QAudio>
#include <QAudioInput>
#include <QAudioOutput>
#include <QIODevice>


#include <QFile>
#include <QDebug>
#include <QMessageBox>//弹出对话框
#include <QPushButton>
#include <QTextEdit>
#include <QVector>
#include <QVBoxLayout>
#include <QTimer>
#include "item.h"
QT_BEGIN_NAMESPACE
namespace Ui { class ClientWidget; }
QT_END_NAMESPACE


const char file_flag = 'F';
const char head_flag = 'H';
const QString MSG_flag = "MSG##";
const char sys_flag = '!';
const char people_new = 'P';//新的用户到来
const char people_del = 'D';//新的用户离开
/***********************************************/
struct people{
    QString pip;
    QString name;
    QString pport;
};


/***********************************************/






class ClientWidget : public QWidget
{
    Q_OBJECT

public:
    ClientWidget(QWidget *parent = nullptr);
    ~ClientWidget();
    void on_pushButtonenter_clicked();

private slots:


    void on_pushButtonsend_clicked();

    void on_pushButtonclose_clicked();

    void on_selectButton_clicked();

    void on_sendButton_clicked();

    void slider();

    void readyReadSlot();
    void onReadyRead();

private:
    Ui::ClientWidget *ui;
    QVBoxLayout *vlayout;
    QWidget *login;
    QWidget *upload;
    QString name, ip;
    int port;
    QVector<ITEM *> items;
    int phone_port;
    QVector<people> plist;

    QTcpSocket *tcpsocket;
    QFile  file;//文件对象
    QString fileName;//文件名字
    qint64 fileSize;//文件大小
    qint64 recvSize;//已接收的文件大小


    //客户端作为发送端
    QFile  file2;//文件对象
    QString fileName2;//文件名字
    qint64 fileSize2;//文件大小
    qint64 sendSize2;//已发送的文件大小

    QTimer timer;//定时器  黏包  头部----文件体
    QMessageBox msgBox;
    bool phone_on;
    bool fileflag;
    bool readyFile;
    void pushMsg(const QString &msg, const QString &name, const QString &alig);
    void updateList();

    //音频
    QTcpSocket *phone_tcpsocket;
    //out
    QAudioOutput *output;
    QIODevice *outputDevice;

    //in
    QAudioInput *input;
    QIODevice *inputDevice;
    bool linktophone=false;


protected:
    void sendData(QTcpSocket* tcpSocket);//发送文件数据
    void paintEvent(QPaintEvent *event);

signals:
    void logined();
};
struct video{
        char audiodata[1024];
        int lens;
    };
#endif // CLIENTWIDGET_H
</code></pre>
<h6 id="clientwidget-cpp"><a href="#clientwidget-cpp" class="headerlink" title="clientwidget.cpp"></a>clientwidget.cpp</h6><pre class=" language-QT"><code class="language-QT">#include "clientwidget.h"
#include "ui_clientwidget.h"
#include <QHostAddress>
#include <QFileDialog>//选择文件的对话框
#include <QPainter>
#include <QInputDialog>
#include <QWidget>
#include <QScrollArea>
#include <QFont>
#include <QPushButton>
#include <QTextEdit>
#include <QAbstractSlider>
#include <QScrollBar>
#include <QLineEdit>
#include <QDebug>
#include <QProgressBar>
#include <windows.h>
#include <QRect>
#include "item.h"
ClientWidget::ClientWidget(QWidget *parent)
    : QWidget(parent)
    , ui(new Ui::ClientWidget)
{
    phone_tcpsocket = new QTcpSocket;
    ip="";
    port = 0;
    ui->setupUi(this);
    ui->sendButton->hide();
    ui->progressBar->hide();
    readyFile = false;
    phone_on = false;
    setWindowTitle("计算机网络点点通信实验");
    resize(1350, 850);
    tcpsocket = NULL;
    tcpsocket = new QTcpSocket(this);
    connect(this, &ClientWidget::close, this, &ClientWidget::on_pushButtonclose_clicked);
    ui->scrollArea->setStyleSheet("background-color:rgba(255,255,255,0)");
    ui->input->setStyleSheet("background-color:rgba(255,255,0,20);"
                             "border-style:solid;"
                             "border-radius:5px;"
                             "border-color:yellow;"
                             "border-width:2.5px;");
    QFont f;
    f.setFamily("微软雅黑");
    f.setPixelSize(20);
    ui->input->setFont(f);
    vlayout = new QVBoxLayout(ui->scrollAreaWidgetContents);
    ui->scrollAreaWidgetContents->setLayout(vlayout);
    vlayout->setDirection(QBoxLayout::BottomToTop);
    vlayout->addStretch(100);
    connect(ui->scrollArea->verticalScrollBar(), &QAbstractSlider::rangeChanged, this, &ClientWidget::slider);

    upload = new QWidget();

    login = new QWidget();
    login->setWindowTitle("SOCKET 通信");
    login->setFixedSize(300, 300);

    QPushButton *namelabel = new QPushButton(login);
    namelabel->setText("用户名");
    namelabel->setGeometry(10,20, 60, 30);
    QLineEdit *name = new QLineEdit(login);
    name->setGeometry(80, 20, 200, 30);

    QPushButton *iplabel = new QPushButton(login);
    iplabel->setText("ip地址");
    iplabel->setGeometry(10,70, 60, 30);
    QLineEdit *ip = new QLineEdit(login);
    ip->setGeometry(80, 70, 200, 30);

    QPushButton *portlabel = new QPushButton(login);
    portlabel->setText("port");
    portlabel->setGeometry(10,120, 60, 30);
    QLineEdit *port = new QLineEdit(login);
    port->setGeometry(80, 120, 200, 30);

    QPushButton *phoneportlabel = new QPushButton(login);
    phoneportlabel->setText("p_port");
    phoneportlabel->setGeometry(10,170, 60, 30);
    QLineEdit *phoneport = new QLineEdit(login);
    phoneport->setGeometry(80, 170, 200, 30);
    phoneport->setText("10085");

    QPushButton *loginbtn = new QPushButton(login);
    loginbtn->setText("登录");
    loginbtn->setGeometry(10, 220, 270, 40);



    login->show();
    connect(loginbtn, &QPushButton::pressed, this, [this, ip, port, name, phoneport](){
        this->name = name->text();
        this->ip = ip->text();
        this->port = port->text().toInt();
        this->phone_port = phoneport->text().toInt();
        if(this->name != "刘朝日" && this->name != "曹文豪" && this->name != "刘硕" && this->name != "刘涵准"
                && this->name != "雷艳")
        {
            return;
        }
        this->on_pushButtonenter_clicked();


    });
    connect(this, &ClientWidget::logined, login, &QWidget::close);
    setMinimumSize(810, 510);
    setMaximumSize(1350, 850);
    ui->onlineListW->setStyleSheet("background-color:rgba(197,232,211,125);");
    ui->progressBar->hide();

    ui->selectButton->setStyleSheet("QPushButton{border-image:url(../src/upload.png);"
                                    "border-radius:40px;}"
                                    "QPushButton:hover{border-image:url(../src/upload_hover.png);"
                                    "border-radius:40px;}");
    ui->phoneButton->setStyleSheet("QPushButton{border-image:url(../src/phone_off.png);"
                                     "border-radius:40px;}"
                                   "QPushButton:hover{border-image:url(../src/phone_hover.png);"
                                   "border-radius:40px;}");
    connect(ui->phoneButton, &QPushButton::pressed, [=](){
        if(phone_on)
        {
            ui->phoneButton->setStyleSheet("QPushButton{border-image:url(../src/phone_off.png);"
                                             "border-radius:40px;}"
                                           "QPushButton:hover{border-image:url(../src/phone_hover.png);"
                                           "border-radius:40px;}");
            phone_tcpsocket->close();
        }
        else
        {
            //获取服务器的ip和端口
            //主动和服务器连接
            phone_tcpsocket->connectToHost(this->ip, this->phone_port);

            ui->phoneButton->setStyleSheet("QPushButton{border-image:url(../src/phone_on.png);"
                                             "border-radius:40px;}"
                                           "QPushButton:hover{border-image:url(../src/phone_onhover.png);"
                                           "border-radius:40px;}");
        }
        phone_on = !phone_on;

    });


    //音频信息/*****************************************************************/


        connect(phone_tcpsocket, &QTcpSocket::connected,
        [=]()
        {
            //提示连接成功
//            ui->textEdit->append("已经加入语音群聊");
        }
        );

        connect(phone_tcpsocket,SIGNAL(readyRead()),this,SLOT(readyReadSlot()));

        //设置参数
        QAudioFormat format;
        format.setSampleRate(8000);
        format.setChannelCount(1);
        format.setSampleSize(16);
        format.setCodec("audio/pcm");
        format.setSampleType(QAudioFormat::SignedInt);
        format.setByteOrder(QAudioFormat::LittleEndian);

        output = new QAudioOutput(format,this);

        outputDevice = output->start();//开始播放

        input = new QAudioInput(format,this);
        inputDevice = input->start();

        connect(inputDevice,SIGNAL(readyRead()),this,SLOT(onReadyRead()));//send

        //音频信息/*****************************************************************/
}


void ClientWidget::paintEvent(QPaintEvent *)
{
    QPainter p(this);
    p.drawPixmap(0, 0, width(), height(), QPixmap("../src/background.jpg"));
    ui->scrollArea->resize(0.75*width(), 0.87*height());
    ui->scrollArea->move(0.25*width(), 0);
    ui->input->resize(0.585*width(), 0.09*height());
    ui->input->move(0.25*width(), 0.90*height());
    ui->pushButtonsend->move(0.85*width(), 0.90*height());
    ui->pushButtonsend->resize(0.14*width(), 0.04*height());
    ui->pushButtonclose->move(0.85*width(), 0.95*height());
    ui->pushButtonclose->resize(0.14*width(), 0.04*height());
    ui->scrollAreaWidgetContents->resize(0.75*width(), 0.87*height());
    ui->onlineListW->resize(0.25*width(), 0.87*height());
    ui->onlineListW->move(0, 0);
    ui->selectButton->resize(0.09*height(), 0.09*height());
    ui->phoneButton->resize(0.09*height(),0.09*height());
    ui->selectButton->move(0.03*width(), 0.90*height());
    ui->phoneButton->move(0.18*width() , 0.90*height());
}

void ClientWidget::slider()
{

    ui->scrollArea->verticalScrollBar()->setValue(ui->scrollArea->verticalScrollBar()->maximumHeight());
}

void ClientWidget::updateList()
{

}
ClientWidget::~ClientWidget()
{
    delete ui;
}

void ClientWidget::pushMsg(const QString &msg, const QString &name, const QString &ali)
{
    ITEM *it = new ITEM(msg, name, ali, ui->scrollAreaWidgetContents);
    vlayout->insertWidget(1, it->Item());
    items.push_back(it);
    it->resize(0.8*width(), 0.1*height());
}
void ClientWidget::on_pushButtonenter_clicked()
{

    //获取服务器的ip和端口
    QString ip = this->ip;
    qint16 port = this->port;
    tcpsocket->connectToHost(QHostAddress(ip),port);

    connect(tcpsocket,&QTcpSocket::connected,
            [=]()
            {
                QString str = people_new+name;
                tcpsocket->write(str.toUtf8().data());
                emit logined();
                show();
            }
            );

    connect(tcpsocket,&QTcpSocket::readyRead,
            [=]()
                {

                    //取出接收的内容
                    QByteArray byteBuf = tcpsocket->readAll();
                    if(byteBuf == "")   return;    //防止空串bug
                    QString buf = byteBuf;
                    if(readyFile)   //传过来的是文件
                    {
                        qint64 len = file.write(byteBuf);
                        recvSize += len;
                        if(recvSize == fileSize)
                        {
                            QString done;done.push_back(sys_flag);done.push_back("filedone");
                            tcpsocket->write(done.toUtf8().data());
                            file.close();
                            QString str = QString("收到文件：[%1: %2KB]").arg(fileName).arg(fileSize/1024);
                            readyFile = false;
                            QMessageBox::information(this,"文件信息",str);
                        }
                    }
                    else if(buf[0] == head_flag) //接收头
                    {
                        qDebug()<<buf<<endl;
                        buf = buf.right(buf.length()-1);
                        //解析头部信息 QString buf = "hello##1024"
                        //初始化
                        fileName = buf.section("##",0,0);
                        fileSize = buf.section("##",1,1).toInt();
                        recvSize = 0;
                        //打开文件
//                        QString filePath1 = QFileDialog::getExistingDirectory(this,"open","./");
//                        qDebug()<<buf<<" "<<isMSG<<endl;
//                        QString filePath1 = fileName;
                        file.setFileName(fileName);//"D:\book\\"+
                        qDebug()<<"收到文件：" + file.fileName()<<endl;
                        bool isOk = file.open(QIODevice::WriteOnly);
                        if(false == isOk)
                        {
                            QMessageBox::information(this,"文件信息","服务器炸了QWQ");
                            close();
                        }
                        readyFile = true;
                    }
                    else if(buf[0]==people_new){//P  ip  ! port ! name
                        QString theip ;
                        QString theport;
                        QString thename;
                        int thej=1;
                        int num=0;
                        for(;thej<buf.size();thej++){
                            if(buf[thej]==sys_flag)break;
                            theip[num] = buf[thej];
                        }
                        thej++;
                        num=0;
                        for(;thej<buf.size();thej++){
                            if(buf[thej]==sys_flag)break;
                            theport[num] = buf[thej];
                        }
                        thej++;
                        num=0;
                        for(;thej<buf.size();thej++){
                            thename[num] = buf[thej];
                        }
                        people thep;
                        thep.pip = theip;
                        thep.name = thename;
                        thep.pport = theport;
                        plist.push_back(thep);
                        return;
                    }
                    else if(buf[0]==people_del){//D ip ! port
                        QString theip ;
                        QString theport;
                        for(int j=1;j<buf.size();j++){

                            if(buf[j]==sys_flag)break;
                            theip[j-1] = buf[j];

                        }
                        bool flag = false;
                        int num=0;
                        for(int j=1;j<buf.size();j++){


                            if(buf[j]!=sys_flag)continue;
                            else {
                                flag = true;
                                continue;
                            }

                            if(flag){
                                theport[num] = buf[j];
                                num++;
                            }


                        }

                        for(int i=0;i<plist.size();i++){
                            if(plist[i].pip == theip && plist[i].pport == theport){
                                plist.remove(i);
                                return;
                            }
                        }

                        return;
                    }
                    else if(buf.left(5) == MSG_flag)   //传过来的是信息
                    {
                        buf = buf.right(buf.length()-5);

                        if(buf.section(":",1,1) == "进入聊天室")
                        {

                        }
                        else if(buf.section(":",1,1) == "离开聊天室")
                        {

                        }
                        else if(name != buf.section(":", 0, 0))
                        {
                            pushMsg(buf.section(":",1,1),buf.section(":", 0, 0) , "left");
                        }
                    }
                }
    );
}

void ClientWidget::on_pushButtonsend_clicked()
{

    //获取内容
    QString str = ui->input->document()->toPlainText();
    if(str == "")
    {
        QMessageBox::information(this,"提示","发送消息不能为空");
        return;
    }
    pushMsg(str, name, "right");
    str = MSG_flag+name+":"+str;
    tcpsocket->write(str.toUtf8().data());
    ui->input->clear();
}

void ClientWidget::on_pushButtonclose_clicked()
{
    //关闭
    QString str;    str.push_back(sys_flag);
    str.push_back("Close");
    tcpsocket->write(str.toUtf8().data());
    tcpsocket->disconnectFromHost();
    tcpsocket->close();
    this->close();
}


//选择文件按钮
void ClientWidget::on_selectButton_clicked()
{
    QString filePath2 = QFileDialog::getOpenFileName(this,"open","../");

    if(false == filePath2.isEmpty())//如果选择文件路径有效
    {
        //初始化
        fileName2.clear();
        fileSize2 = 0;
        sendSize2 = 0;

        //获取文件信息
        QFileInfo info(filePath2);
        fileName2 = info.fileName();
        fileSize2 = info.size();

        //只读方式打开文件
        //指定文件名
        file2.setFileName(filePath2);

        //打开文件
        bool isOk = file2.open(QIODevice::ReadOnly);
        if(false == isOk)
        {
            qDebug() << "只读方式打开文件失败 77";
            return;
        }
        upload->setWindowTitle("文件上传");
        ui->progressBar->setValue(0);
        ui->progressBar->setRange(0, fileSize2);
        ui->progressBar->setParent(upload);
        ui->progressBar->show();
        ui->sendButton->setParent(upload);
        ui->sendButton->show();
        ui->progressBar->setGeometry(20, 20, 200, 50);
        ui->sendButton->setGeometry(250, 20, 100, 50);
        upload->show();
    }
    else
    {
        qDebug() << "选择文件路径出错 62";
    }
}


//反向发送按钮
void ClientWidget::on_sendButton_clicked()
{
    qDebug()<<"on_sendButton_clicked"<<endl;
    //先发送文件头信息 文件名##文件大小
    QString head = head_flag + QString("##%1##%2").arg(fileName2).arg(fileSize2);
    qDebug()<<head<<endl;
    //发送头部信息
    qint64 len = tcpsocket->write(head.toUtf8());

    if(len > 0)//头部信息发送成功
    {
        //发送真正的文件信息
        //防止TCP黏包，需要通过定时器延时20ms
        timer.start(200);

        //文件传输计时器
        connect(&timer,&QTimer::timeout,
                [=]()
                {
                    //关闭定时器
                    timer.stop();

                    //发送文件

                    sendData(tcpsocket);
                }
        );
    }
    else{
        qDebug() << "头部信息发送失败 110";
        file2.close();
    }

}

//发送文件
void ClientWidget::sendData(QTcpSocket* tcpSocket)
{
    qint64 len = 0;

    do
    {
        //每次发送数据的单位（缓冲区大小）
        char buf[4 * 1024] = {0};
        len = 0;

        //往文件中读数据
        len = file2.read(buf,sizeof(buf));
        len = tcpSocket->write(buf,len);
        //发送的数据需要累积
        sendSize2 += len;
        ui->progressBar->setValue(sendSize2);
    }while(len > 0);

    //判断是否发送文件完毕
    if(sendSize2 == fileSize2)
    {
        QMessageBox::information(NULL, "transport", "文件发送完毕！");
        ui->progressBar->hide();
        sendSize2 = 0;//以免重复弹出完成提示
    }
    file2.close();
    upload->close();
}


/*****************************音频信息*************************/
void ClientWidget::readyReadSlot(){
        int size = output->periodSize();
        QByteArray bug;
        video vp;
        memset(&vp,0,sizeof(vp));
        //监听音频   并且传送
        qDebug()<<"我在接收呢"<<endl;
        bug = phone_tcpsocket->readAll();
        outputDevice->write(bug,size);
}


void ClientWidget::onReadyRead()//send
{
        qDebug()<<"It's sending audio!"<<endl;
        video vp;
        memset(&vp,0,sizeof(vp));
        //读取音频
        vp.lens = inputDevice->read(vp.audiodata,1024);
        phone_tcpsocket->write((const char*)&vp,sizeof(vp));
        //先给服务发送(接收文件完成的信息)
}</code></pre>
<h6 id="main-cpp-1"><a href="#main-cpp-1" class="headerlink" title="main.cpp"></a>main.cpp</h6><pre class=" language-QT"><code class="language-QT">#include "clientwidget.h"

#include <QApplication>
#include <QStyleFactory>
#include <QWidget>
int main(int argc, char *argv[])
{
    QApplication a(argc, argv);
    a.setStyle(QStyleFactory::create("Fusion"));
    ClientWidget w;
    return a.exec();
}</code></pre>
<h4 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h4><ul>
<li>仅仅支持同一局域网内通讯</li>
<li>若连接外网（比如河北的物理机）可以使用花生壳（免费1G）等端口映射工具；</li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">LiuShuo</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://LiuShuo1999.github.io/2020/05/16/QT-TCP%E9%80%9A%E8%AE%AF/">http://LiuShuo1999.github.io/2020/05/16/QT-TCP%E9%80%9A%E8%AE%AF/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">LiuShuo</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/QT/">
                                    <span class="chip bg-color">QT</span>
                                </a>
                            
                                <a href="/tags/%E8%AE%A1%E7%BD%91%E8%AF%BE%E8%AE%BE/">
                                    <span class="chip bg-color">计网课设</span>
                                </a>
                            
                                <a href="/tags/TCP%E9%80%9A%E8%AE%AF/">
                                    <span class="chip bg-color">TCP通讯</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'Kcp6fHlGdpBpK4kOgr23OU2R-gzGzoHsz',
        appKey: 'WWFi5sjpXcfPV7YLLOMOYAf7',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2020/05/16/QT-TCP%E9%80%9A%E8%AE%AF/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="QT-TCP通讯">
                        
                        <span class="card-title">QT-TCP通讯</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            [toc]
实现内容
多人聊天室
文件传输
多人语音聊天室

效果截图服务器端
客户端
代码服务器端注 pro文件需要添加
QT       += core gui network multimedia
serverwidget.h#ifn
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-05-16
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            LiuShuo
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/QT/">
                        <span class="chip bg-color">QT</span>
                    </a>
                    
                    <a href="/tags/%E8%AE%A1%E7%BD%91%E8%AF%BE%E8%AE%BE/">
                        <span class="chip bg-color">计网课设</span>
                    </a>
                    
                    <a href="/tags/TCP%E9%80%9A%E8%AE%AF/">
                        <span class="chip bg-color">TCP通讯</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/05/14/scanf-%E8%B8%A9%E5%9D%91/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="scanf 踩坑">
                        
                        <span class="card-title">scanf 踩坑</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            scanf(“%c”,ch);这样会读入空格和回车符以下两种写法可以忽略回车符和空格
cin>>ch;
scanf(" %c",&amp;ch);

        document.querySelectorAll('.github-em
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-05-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            LiuShuo
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/">
                        <span class="chip bg-color">程序设计</span>
                    </a>
                    
                    <a href="/tags/%E9%94%99%E9%A2%98/">
                        <span class="chip bg-color">错题</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="/about" target="_blank">LiuShuo</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">5.3k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/blinkfox" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1114988147" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1114988147" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
